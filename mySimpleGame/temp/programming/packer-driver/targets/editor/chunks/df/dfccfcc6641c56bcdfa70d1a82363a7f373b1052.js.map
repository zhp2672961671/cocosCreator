{"version":3,"sources":["file:///E:/myCocosGame/mySimpleGame/assets/simple-run/scripts/PlayerController.ts"],"names":["_decorator","Component","Vec3","CCFloat","input","Input","SkeletalAnimationComponent","AudioClip","AudioSourceComponent","AnimationComponent","tween","GameDefines","GameState","ccclass","property","tempVec3_a","MoveAction","MoveState","cocosAnim","idle","run","jump","PlayerController","type","onTriggerCoin","onTriggerBlock","_pressedX","_pressedY","_moveState","RUNNING","_gameState","INIT","_audioSourceComp","start","getComponent","onGameInit","playerAnimComp","play","node","setPosition","set","onGamePlaying","jumpState","getState","on","EventType","FINISHED","onJumpEnd","TOUCH_START","onViewTouchStart","TOUCH_END","onViewTouchEnd","onGameEnd","off","onTriggerEnter","event","triggerNode","otherCollider","name","playOneShot","coinAC","animComp","downName","state","isPlaying","location","getLocation","x","y","touchPoint","endX","endY","Math","abs","move","LEFT","RIGHT","UP","moveAction","by","position","leftLineX","onComplete","MOVING_LEFT","rightLineX","MOVING_RIGHT","jumpAC","crossFade","speed","JUMPING","update","deltaTime","PLAYING","translate","onDestroy"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Vec3, CCFloat,input, Input,SkeletalAnimationComponent, AudioClip, AudioSourceComponent, AnimationComponent, EventTouch, tween, ITriggerEvent } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\nimport {GameDefines, GameState} from './GameDefines';\r\nconst tempVec3_a = new Vec3();\r\n\r\nenum MoveAction {\r\n    LEFT,\r\n    RIGHT,\r\n    UP,\r\n}\r\n\r\nenum MoveState {\r\n    RUNNING,\r\n    MOVING_LEFT,\r\n    MOVING_RIGHT,\r\n    JUMPING,\r\n}\r\nconst cocosAnim = {\r\n    idle: 'cocos_anim_idle',\r\n    run: 'cocos_anim_run',\r\n    jump: 'cocos_anim_jump',\r\n}\r\n@ccclass('PlayerController')\r\nexport class PlayerController extends Component {\r\n    @property({type: CCFloat})\r\n    public speed: number = 1;\r\n// 骨骼动画组件\r\n    @property({type: SkeletalAnimationComponent})\r\n    public playerAnimComp: SkeletalAnimationComponent = null;\r\n    @property({type: AudioClip})\r\n    public coinAC: AudioClip = null;\r\n    @property({type: AudioClip})\r\n    public jumpAC: AudioClip = null;\r\n    public onTriggerCoin: (coinNode: Node) => void;\r\n    public onTriggerBlock: (roadBlockNode: Node) => void;\r\n\r\n    private _pressedX = 0;\r\n    private _pressedY = 0;\r\n\r\n    private _moveState: MoveState = MoveState.RUNNING;\r\n    private _gameState: GameState = GameState.INIT;\r\n\r\n    private _audioSourceComp: AudioSourceComponent = null;\r\n    start() {\r\n\r\n        this._audioSourceComp = this.getComponent(AudioSourceComponent);\r\n    }\r\n    // 游戏初始\r\n    onGameInit() {\r\n        // 播放动画\r\n        this.playerAnimComp.play(cocosAnim.idle);\r\n        // 设置位置\r\n        this.node.setPosition(tempVec3_a.set(0, 0, 0));\r\n    }\r\n    // 开始游戏\r\n    onGamePlaying() {\r\n        // 切换状态位\r\n        this._moveState = MoveState.RUNNING;\r\n        // 播放跑步动画\r\n        this.playerAnimComp.play(cocosAnim.run);\r\n        const jumpState = this.playerAnimComp.getState(cocosAnim.jump);\r\n        // 注册监听\r\n        jumpState.on(AnimationComponent.EventType.FINISHED, this.onJumpEnd,this);\r\n        input.on(Input.EventType.TOUCH_START, this.onViewTouchStart, this);\r\n        input.on(Input.EventType.TOUCH_END, this.onViewTouchEnd, this);\r\n\r\n    }\r\n    // 游戏结束\r\n    onGameEnd() {\r\n        const jumpState = this.playerAnimComp.getState(cocosAnim.jump);\r\n        jumpState.off(AnimationComponent.EventType.FINISHED, this.onJumpEnd, this);\r\n\r\n        input.off(Input.EventType.TOUCH_START, this.onViewTouchStart, this);\r\n        input.off(Input.EventType.TOUCH_END, this.onViewTouchEnd, this);\r\n    }\r\n\r\n    onTriggerEnter(event: ITriggerEvent) {\r\n        const triggerNode: Node = event.otherCollider.node;\r\n        if (triggerNode.name === 'Coin') {\r\n            this._audioSourceComp.playOneShot(this.coinAC);\r\n            if (this.onTriggerCoin) {\r\n                this.onTriggerCoin(triggerNode);\r\n            }\r\n        } else if (triggerNode.name === 'RoadBlock') {\r\n            const animComp = triggerNode.getComponent(AnimationComponent);\r\n            const downName = 'block_down';\r\n            const state = animComp.getState(downName);\r\n            if (!state.isPlaying) {\r\n                animComp.play(downName);\r\n            }\r\n            if (this.onTriggerBlock) {\r\n                this.onTriggerBlock(triggerNode);\r\n            }\r\n        }\r\n    }\r\n    // 跳跃动作结束\r\n    onJumpEnd(type, state) {\r\n        if (state?.name === cocosAnim.jump) {\r\n            this.playerAnimComp.play(cocosAnim.run);\r\n            this._moveState = MoveState.RUNNING;\r\n        }\r\n    }\r\n    // 触摸开始\r\n    onViewTouchStart(event: EventTouch) {\r\n        let location = event.getLocation();// 获取节点坐标\r\n        // 记录触摸开始位置\r\n        this._pressedX = location.x;\r\n        this._pressedY = location.y;\r\n    }\r\n    //触摸结束\r\n    onViewTouchEnd(event: EventTouch) {\r\n        let touchPoint = event.getLocation();\r\n        let endX = this._pressedX - touchPoint.x;\r\n        let endY = this._pressedY - touchPoint.y;\r\n\r\n        if (Math.abs(endX) > Math.abs(endY)){\r\n            //手势向左右\r\n            //判断向左还是向右\r\n            if (endX  > 0){\r\n                // left\r\n                this.move(MoveAction.LEFT);\r\n            } else {\r\n                // right\r\n                this.move(MoveAction.RIGHT);\r\n            }\r\n        } else {\r\n            //手势向上下\r\n            //判断手势向上还是向下\r\n            if (endY  > 0){\r\n                // down\r\n            } else {\r\n                // up\r\n                this.move(MoveAction.UP);\r\n            }\r\n         }\r\n    }\r\n    move(moveAction: MoveAction) {\r\n        switch (moveAction) {\r\n            case MoveAction.LEFT:\r\n                if (this._moveState === MoveState.RUNNING) {\r\n                    tween(this.node)\r\n                        .by(0.5, {position: new Vec3(GameDefines.leftLineX, 0, 0)}, {onComplete: ()=> {\r\n                            this._moveState = MoveState.RUNNING;\r\n                        }})\r\n                        .start();\r\n                    this._moveState = MoveState.MOVING_LEFT;\r\n                }\r\n                break;\r\n            case MoveAction.RIGHT:\r\n                if (this._moveState === MoveState.RUNNING) {\r\n                    tween(this.node)\r\n                    .by(0.5, {position: new Vec3(GameDefines.rightLineX, 0, 0)}, {onComplete: ()=> {\r\n                        this._moveState = MoveState.RUNNING;\r\n                    }})\r\n                    .start();\r\n                    this._moveState = MoveState.MOVING_RIGHT;\r\n                }\r\n                break;\r\n            case MoveAction.UP:\r\n                if (this._moveState === MoveState.RUNNING) {\r\n                    this._audioSourceComp.playOneShot(this.jumpAC);\r\n                    this.playerAnimComp.crossFade(cocosAnim.jump);\r\n                    const state = this.playerAnimComp.getState(cocosAnim.jump);\r\n                    state.speed = 1.5;\r\n                    tween(this.node)\r\n                    .by(0.75, {position: new Vec3(0, 0, 10)}, {onComplete: ()=> {\r\n                        // this._moveState = MoveState.RUNNING;\r\n                    }})\r\n                    .start();\r\n                    this._moveState = MoveState.JUMPING;\r\n                }\r\n                break;\r\n        }\r\n    }\r\n\r\n\r\n\r\n    update (deltaTime: number) {\r\n        if (this._gameState === GameState.PLAYING) {\r\n            if (this._moveState === MoveState.JUMPING) {\r\n                // this.node.translate(tempVec3_a.set(0, 0, this.speed * 1.5 * deltaTime));\r\n            } else {\r\n                this.node.translate(tempVec3_a.set(0, 0, this.speed * deltaTime));\r\n            }\r\n        }\r\n    }\r\n\r\n    onDestroy() {\r\n        input.off(Input.EventType.TOUCH_START, this.onViewTouchStart, this);\r\n        input.off(Input.EventType.TOUCH_END, this.onViewTouchEnd, this);\r\n    }\r\n}\r\n\r\n\r\n"]}