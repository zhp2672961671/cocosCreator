{"version":3,"sources":["file:///E:/myCocosGame/mySimpleGame/assets/simple-run/scripts/GameManager.ts"],"names":["_decorator","Component","Node","Vec3","Prefab","LabelComponent","NodePool","instantiate","math","AnimationComponent","PlayerController","GameDefines","GameState","ccclass","property","tempVec3_a","GameManager","type","_coinPool","_coinNum","_straitFloorPool","_roadBlockPool","_checkPassedTime","_checkInterval","_activeFloors","_curState","INIT","coinNum","value","coinScoreLabel","string","curState","initPanel","active","playingPanel","endPanel","reset","PLAYING","END","playerCtrl","onGameStateChanged","start","forEach","floorNode","destroyFloor","i","maxActiveFloor","posZ","floorLength","needItem","generateFloor","set","j","children","length","child","name","CoinNodeName","parent","put","BlockNodeName","pos","generateItem","createStraitFloor","push","generateType","randomRangeInt","createCoin","randomXPos","createRoadBlock","straitFloorNode","size","get","straitFloorPrfb","setPosition","node","localPos","coinNode","coinPrfb","roadBlock","roadBlockPrfb","animComp","getComponent","downName","state","getState","setTime","sample","posXPool","leftLineX","middleLineX","rightLineX","index","posX","update","deltaTime"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Vec3, Prefab, LabelComponent, NodePool, instantiate, math, AnimationComponent } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\nimport { PlayerController } from './PlayerController';\r\nimport {GameDefines, GameState } from './GameDefines';\r\nconst tempVec3_a = new Vec3();\r\n\r\n@ccclass('GameManager')\r\nexport class GameManager extends Component {\r\n    @property({type: Prefab})\r\n    public straitFloorPrfb: Prefab = null;\r\n\r\n    @property({type: Prefab})\r\n    public coinPrfb: Prefab = null;\r\n    @property({type: Prefab})\r\n    public roadBlockPrfb: Prefab = null;\r\n\r\n    @property({type: PlayerController})\r\n    public playerCtrl: PlayerController = null;\r\n    @property({type: LabelComponent})\r\n    public coinScoreLabel: LabelComponent = null;\r\n\r\n    @property({type: Node})\r\n    public initPanel: Node = null;\r\n    @property({type: Node})\r\n    public playingPanel: Node = null;\r\n    @property({type: Node})\r\n    public endPanel: Node = null;\r\n    private _coinPool: NodePool = new NodePool();\r\n    private _coinNum: number = 0;\r\n    private _straitFloorPool: NodePool = new NodePool();\r\n    private _roadBlockPool: NodePool = new NodePool();\r\n    private _checkPassedTime: number = 0;\r\n    private _checkInterval: number = 1;\r\n    private _activeFloors: Node[] = [];\r\n    private _curState: GameState = GameState.INIT;\r\n\r\n    get coinNum() {\r\n        return this._coinNum;\r\n    }\r\n\r\n    set coinNum(value: number) {\r\n        this._coinNum = value;\r\n        this.coinScoreLabel.string = ''+value;\r\n    }\r\n\r\n    set curState(value: GameState) {\r\n        switch(value) {\r\n            case GameState.INIT:\r\n                this.initPanel.active = true;\r\n                this.playingPanel.active = false;\r\n                this.endPanel.active = false;\r\n                this.reset();\r\n                break;\r\n            case GameState.PLAYING:\r\n                this.initPanel.active = false;\r\n                this.playingPanel.active = true;\r\n                this.coinNum = 0;\r\n\r\n                break;\r\n            case GameState.END:\r\n                this.playingPanel.active = false;\r\n                this.endPanel.active = true;\r\n                break;\r\n        }\r\n\r\n        this._curState = value;\r\n        this.playerCtrl.onGameStateChanged(value);\r\n    }\r\n\r\n    get curState() {\r\n        return this._curState;\r\n    }\r\n    start() {\r\n\r\n    }\r\n    reset() {\r\n        // clear all\r\n        this._activeFloors.forEach((floorNode: Node) => {\r\n            this.destroyFloor(floorNode);\r\n        });\r\n        this._activeFloors = [];\r\n\r\n        // init\r\n        for (let i = 0; i < GameDefines.maxActiveFloor; i++) {\r\n            const posZ = i * GameDefines.floorLength;\r\n            let needItem = false;\r\n            if (i > 1) {\r\n                needItem = true;\r\n            }\r\n\r\n            this.generateFloor(tempVec3_a.set(0, 0, posZ), needItem);\r\n        }\r\n    }\r\n\r\n    // 销毁地面\r\n    destroyFloor(floorNode: Node) {\r\n        for (let j = 0; j < floorNode.children.length; j++) {\r\n            const child = floorNode.children[j];\r\n            // 回收金币1和障碍物\r\n            if (child.name === GameDefines.CoinNodeName) {\r\n                child.parent = null;\r\n                this._coinPool.put(child);\r\n            } else if (child.name === GameDefines.BlockNodeName) {\r\n                child.parent = null;\r\n                this._roadBlockPool.put(child);\r\n            }\r\n\r\n        }\r\n        this._straitFloorPool.put(floorNode);\r\n    }\r\n\r\n    generateFloor(pos: Vec3, generateItem: boolean = false) {\r\n        let floorNode = this.createStraitFloor(pos);\r\n        this._activeFloors.push(floorNode);\r\n\r\n        if (generateItem) {\r\n            const generateType = math.randomRangeInt(0, 3);\r\n            if (generateType === 1) {\r\n                this.createCoin(floorNode, tempVec3_a.set(this.randomXPos(), 1, 0));\r\n            } else if (generateType === 2) {\r\n                this.createRoadBlock(floorNode, tempVec3_a.set(this.randomXPos(), 0, 0));\r\n            }\r\n        }\r\n    }\r\n    // 创建地面\r\n    createStraitFloor(pos: Vec3) {\r\n        let straitFloorNode: Node = null;\r\n        if (this._straitFloorPool.size() > 0) {\r\n            straitFloorNode = this._straitFloorPool.get();\r\n        } else {\r\n            straitFloorNode = instantiate(this.straitFloorPrfb);\r\n        }\r\n\r\n        straitFloorNode.setPosition(pos);\r\n        straitFloorNode.parent = this.node;\r\n\r\n        return straitFloorNode;\r\n    }\r\n    createCoin(parent: Node, localPos: Vec3) {\r\n        let coinNode: Node = null;\r\n        if (this._coinPool.size() > 0) {\r\n            coinNode = this._coinPool.get();\r\n        } else {\r\n            coinNode = instantiate(this.coinPrfb);\r\n        }\r\n        coinNode.setPosition(localPos);\r\n        coinNode.parent = parent;\r\n\r\n        return coinNode;\r\n    }\r\n\r\n    createRoadBlock(parent: Node, localPos: Vec3) {\r\n        let roadBlock: Node = null;\r\n        if (this._roadBlockPool.size() > 0) {\r\n            roadBlock = this._roadBlockPool.get();\r\n        } else {\r\n            roadBlock = instantiate(this.roadBlockPrfb);\r\n        }\r\n\r\n        roadBlock.setPosition(localPos);\r\n        roadBlock.parent = parent;\r\n\r\n        const animComp = roadBlock.getComponent(AnimationComponent);\r\n        const downName = 'block_down';\r\n        const state = animComp.getState(downName);\r\n        state.setTime(0);\r\n        state.sample();\r\n\r\n        return roadBlock;\r\n    }\r\n    // 获取随机位置\r\n    randomXPos() {\r\n        const posXPool: number[] = [GameDefines.leftLineX, GameDefines.middleLineX, GameDefines.rightLineX];\r\n        const index = math.randomRangeInt(0, 3);\r\n        const posX: number = posXPool[index];\r\n\r\n        return posX;\r\n    }\r\n\r\n\r\n\r\n    update(deltaTime: number) {\r\n\r\n    }\r\n}\r\n\r\n\r\n"]}