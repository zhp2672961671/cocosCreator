{"version":3,"sources":["file:///E:/myCocosGame/cocosCreator/myYoumingArcher/assets/script/framework/audioManager.ts"],"names":["_decorator","AudioClip","Lodash","StorageManager","ResourceUtil","ccclass","property","AudioManager","dictWeaponSoundIndex","musicVolume","soundVolume","audios","arrSound","instance","_instance","init","getAudioSetting","onAppShow","name","audio","loop","clip","play","isMusic","state","getGlobalData","playMusic","path","loadRes","err","tmp","playClip","playSound","push","setLoop","setVolume","playOneShot","once","remove","obj","volume","stop","hasOwnProperty","stopAll","i","setMusic","flag","item","pauseAll","console","log","pause","resumeAll","openMusic","setGlobalData","closeMusic","openSound","setSound","closeSound","idx","length","stopSingleSound"],"mappings":"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","sourcesContent":["import { Lodash } from './lodash';\nimport { _decorator, AudioClip } from \"cc\";\nimport { StorageManager } from \"./storageManager\";\nimport { ResourceUtil } from \"./resourceUtil\";\nconst { ccclass, property } = _decorator;\n@ccclass(\"AudioManager\")\nexport class AudioManager  {\n    public dictWeaponSoundIndex: any = {};\n    public musicVolume: number = 0.8;\n    public soundVolume: number = 1;\n    public audios: any = {};\n    public arrSound: any = [];\n\n    public static _instance: AudioManager;\n\n    public static get instance () {\n        if (this._instance) {\n            return this._instance;\n        }\n\n        this._instance = new AudioManager();\n        this._instance.init();\n        return this._instance;\n    }\n\n    public init () {\n        this.musicVolume = this.getAudioSetting(true) ? 0.8: 0;\n        this.soundVolume = this.getAudioSetting(false) ? 1 : 0;\n    }\n\n    public onAppShow () {\n        for (let name in this.audios) {\n            let audio = this.audios[name];\n            if (audio.loop) {\n                //属于无限循环的，则需要在wx环境下自己开启播放\n                audio.clip.play();\n            }\n        }\n    }\n\n    public getAudioSetting (isMusic: boolean) {\n        let state;\n        if (isMusic) {\n            state = StorageManager.instance.getGlobalData('music');\n        } else {\n            state = StorageManager.instance.getGlobalData('sound');\n        }\n\n        // console.log('Config for [' + (isMusic ? 'Music' : 'Sound') + '] is ' + state);\n\n        return !state || state === 'true' ? true : false;\n    }\n\n    /**\n     * 播放音乐\n     * @param {String} name 音乐名称可通过constants.AUDIO_MUSIC 获取\n     * @param {Boolean} loop 是否循环播放\n     */\n     public playMusic (name:string, loop: boolean) {\n        let path = 'audio/music/' + name;\n        //微信特殊处理，除一开场的音乐，其余的放在子包里头\n        // if (name !== 'click') {\n        //     path =  path; //微信特殊处理，除一开场的音乐，其余的放在子包里头\n        // }\n         \n        ResourceUtil.loadRes(path, AudioClip, (err: any, clip: any)=> {\n            let tmp = {} as any;\n            tmp.clip = clip;\n            tmp.loop = loop;\n            tmp.isMusic = true;\n            this.audios[name] = tmp;\n            this.playClip(name, true); \n        });     \n    }\n\n    /**\n     * 播放音效\n     * @param {String} name 音效名称可通过constants.AUDIO_SOUND 获取\n     * @param {Boolean} loop 是否循环播放\n     */\n    public playSound (name:string, loop:boolean = false) {\n        if (!this.soundVolume) {\n            return;\n        }\n\n        //音效一般是多个的，不会只有一个\n        let path = 'audio/sound/';\n        // if (name !== 'click') {\n        //     path = path; //微信特殊处理，除一开场的音乐，其余的放在子包里头\n        // }\n\n        ResourceUtil.loadRes(path + name, AudioClip, (err: any, clip: any)=> {\n            let tmp = {} as any;\n            tmp.clip = clip;\n            tmp.loop = loop;\n            tmp.isMusic = false;\n            this.arrSound.push(tmp);\n\n            if (loop) {\n                this.audios[name] = tmp;\n                clip.setLoop(loop);\n            }\n\n            clip.setVolume(this.soundVolume);\n            \n            clip.playOneShot();\n\n            clip.once('ended', ()=>{\n                Lodash.remove(this.arrSound, (obj: any)=>{\n                    return obj.clip === tmp.clip;\n                });\n            })\n        });\n    }\n\n    public playClip (name: string, isMusic?: boolean) {\n        // console.log('playClip: ' + JSON.stringify(this.audios));\n        let audio = this.audios[name];\n        // if (typeof audio.audioId === \"number\") {\n        //     let state = cc.audioEngine.getState(audio.audioId);\n        //     if (state === cc.audioEngine.AudioState.PLAYING && audio.loop) return;\n        // }\n\n        let volume = this.musicVolume;\n        if (!isMusic) {\n            volume = this.soundVolume;\n        }\n\n        let clip = audio.clip as AudioClip;\n        clip.setVolume(volume);\n        clip.setLoop(audio.loop);\n        clip.play();\n        // let audioId = cc.audioEngine.play(audio.clip, audio.loop, volume);\n        // audio.audioId = audioId;\n    }\n\n    public stop (name: any) {\n        if (this.audios.hasOwnProperty(name)) {\n            let audio = this.audios[name];\n            audio.clip.stop();\n        }\n    }\n\n    public stopAll () {\n        for (const i in this.audios) {\n            if (this.audios.hasOwnProperty(i)) {\n                let audio = this.audios[i];\n                audio.clip.stop();\n            }\n        }\n    }\n\n    public setMusic (flag: any) {\n        if (typeof flag !== \"number\") {\n            flag = flag ? 1 : 0;\n        }\n\n        this.musicVolume = flag;\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item) && this.audios[item].isMusic) {\n                // this.changeState(item, flag);\n                let audio = this.audios[item];\n                audio.clip.setVolume(this.musicVolume);\n            }\n        }\n    }\n\n    //看广告时先将音乐暂停\n    public pauseAll () {\n        console.log(\"pause all music!!!\");\n\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item)) {\n                let audio = this.audios[item];\n                audio.clip.pause();\n            }\n        }\n    }\n\n    public resumeAll () {\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item)) {\n                let audio = this.audios[item];\n                audio.clip.play();\n            }\n        }\n    }\n\n    public openMusic () {\n        this.setMusic(0.8);\n        StorageManager.instance.setGlobalData('music', 'true');\n    }\n\n    public closeMusic () {\n        this.setMusic(0);\n        StorageManager.instance.setGlobalData('music', 'false');\n    }\n\n    public openSound () {\n        this.setSound(1);\n        StorageManager.instance.setGlobalData('sound', 'true');\n    }\n\n    public closeSound () {\n        this.setSound(0);\n        StorageManager.instance.setGlobalData('sound', 'false');\n    }\n\n    public setSound (flag: any) {\n        this.soundVolume = flag;\n        for (let item in this.audios) {\n            if (this.audios.hasOwnProperty(item) && !this.audios[item].isMusic) {\n                // this.changeState(item, flag);\n                let audio = this.audios[item];\n                audio.clip.setVolume(this.soundVolume);\n            }\n        }\n\n        for (let idx = 0; idx < this.arrSound.length; idx++) {\n            let audio = this.arrSound[idx];\n            audio.clip.setVolume(this.soundVolume);\n        }\n    }\n\n    public stopSingleSound (name: string) {\n        if (this.audios.hasOwnProperty(name) && !this.audios[name].isMusic) {\n            let audio = this.audios[name];\n            audio.clip.stop();\n        }\n    }\n}\n"]}