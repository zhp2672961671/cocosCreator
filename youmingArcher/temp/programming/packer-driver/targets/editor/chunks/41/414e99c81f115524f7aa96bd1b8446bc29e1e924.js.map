{"version":3,"sources":["file:///E:/myCocosGame/youmingArcher/assets/script/utils/joystick.ts"],"names":["_decorator","Component","Node","Enum","UITransformComponent","Vec3","view","AudioManager","PlayerData","Constant","GameManager","ClientEvent","ccclass","property","TOUCH_TYPE","DEFAULT","FOLLOW","FOLLOW_ALWAYS","FOLLOW_DOT","DIRECTION_TYPE","FOUR","EIGHT","ALL","screenHeight","getVisibleSize","height","Joystick","type","displayName","onClickCb","onEndCb","clearFECb","onBeginFECb","onSuccessFECb","isMoving","_angle","_oriRingPos","_targetRingPos","_touchStartLocation","_touchMoveLocation","_touchEndLocation","_isOutInnerSize","_distanceRate","_checkInterval","_oldAngle","_currentTime","_oriDotPos","_movePos","_curRingPos_1","_curRingPos_2","distanceRate","angle","v","start","instance","playerInfo","level","ndTip","active","onEnable","node","on","EventType","TOUCH_START","_touchStartEvent","TOUCH_MOVE","_touchMoveEvent","TOUCH_END","_touchEndEvent","TOUCH_CANCEL","onDisable","off","ndDot","setPosition","ndRing","event","touch","getUILocation","set","x","y","touchPos","getComponent","convertToNodeSpaceAR","getPosition","clone","isFollowStart","distance","length","width","contentSize","radius","_updateAngle","touchType","innerSize","isGameStart","resumeAll","dispatchEvent","EVENT_TYPE","MONSTER_MOVE","rate","Number","toFixed","radian","Math","atan2","cos","sin","ringPos","isDragToInner","pos","round","PI","reset","update","deltaTime","isGameOver","isGamePause","scriptPlayer","lerp","position","playAction","action","PLAYER_ACTION","MOVE","value","STOP_MOVE"],"mappings":"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","sourcesContent":["import { AudioManager } from './../framework/audioManager';\nimport { PlayerData } from './../framework/playerData';\nimport { Constant } from './../framework/constant';\nimport { GameManager } from './../fight/gameManager';\nimport { _decorator, Component, Node, Enum, EventTouch, UITransformComponent, Vec3, view } from \"cc\";\nimport { ClientEvent } from '../framework/clientEvent';\nconst { ccclass, property } = _decorator;\n\n//触摸类型\nconst TOUCH_TYPE = Enum({\n    DEFAULT: 0,//按钮和背景距离不变，背景位置与触碰点一致，不可改变按钮背景位置，按钮背景随着按钮移动而移动，松手后无法恢复到初始位置\n    FOLLOW: 1,//按钮和背景距离不变，背景位置与触碰点一致，不可改变按钮背景位置，按钮背景随着按钮移动而移动，松手后恢复到初始位置\n    FOLLOW_ALWAYS: 2, //按钮和背景距离不变，背景位置与触碰点一致，可改变按钮背景位置，按钮背景随着按钮移动而移动，松手后恢复到初始位置\n    FOLLOW_DOT: 3 //按钮和背景距离可改变，按钮位置与触碰点可不一致，不可改变按钮背景位置，按钮背景不随着按钮移动而移动，松手后恢复到初始位置\n});\n\n//方向\nconst DIRECTION_TYPE = Enum({\n    FOUR: 4,\n    EIGHT: 8,\n    ALL: 0,\n});\n\nconst screenHeight = view.getVisibleSize().height;//屏幕可视范围高度\n\n@ccclass(\"Joystick\")\nexport class Joystick extends Component {\n    @property({type: Node, displayName: '摇杆背景节点'})\n    public ndRing: Node = null!;\n\n    @property({type: Node, displayName: '摇杆节点'})\n    public ndDot: Node = null!;\n\n    @property({type: TOUCH_TYPE, displayName: '触摸类型'})\n    public touchType = TOUCH_TYPE.DEFAULT;\n\n    @property({type: DIRECTION_TYPE, displayName: '方向类型'})\n    public directionType = DIRECTION_TYPE.ALL;\n\n    @property({displayName: '启动半透明'})\n    public isEnableTransparent: boolean = false;\n\n    @property({displayName: '点击跟随'})\n    public isFollowStart: boolean = false;\n\n    @property({displayName: '内圈大小'})\n    public innerSize: number = 10;\n\n    @property(Node)\n    public ndTip: Node = null!;//第一关文字提示\n\n    public onClickCb: Function = null!;\n    public onEndCb: Function = null!;\n    public clearFECb: Function = null!;\n    public onBeginFECb: Function = null!;\n    public onSuccessFECb: Function = null!;\n    public isMoving: boolean = false;//是否正在移动\n\n    public get distanceRate () {\n        return this._distanceRate;\n    }\n\n    public get angle () {\n        return this._angle;\n    }\n\n    public set angle (v: number) {\n        this._angle = v;\n    }\n\n    private _angle: number = 0;//当前的角度\n    private _oriRingPos: Vec3 = null!;//圆圈初始位置\n    private _targetRingPos: Vec3 = new Vec3();//圆圈背景位置\n    private _touchStartLocation: Vec3 = new Vec3();//开始触碰位置\n    private _touchMoveLocation: Vec3 = new Vec3();//移动触碰位置\n    private _touchEndLocation: Vec3 = new Vec3();//结束触碰位置\n    private _isOutInnerSize: Boolean = false;//终点拖动的点是否超出按钮圆圈背景\n    private _distanceRate: number = 0; //遥感移动距离比\n    private _checkInterval: number = 0.04;//每40ms刷新一次\n    private _oldAngle: number = 0;//之前的角度\n    private _currentTime: number = 0;//当前累积时间\n    private _oriDotPos: Vec3 = new Vec3();//中间按钮初始坐标\n    private _movePos: Vec3 = new Vec3();//移动坐标\n    private _curRingPos_1: Vec3 = new Vec3();//当前圆圈坐标\n    private _curRingPos_2: Vec3 = new Vec3();//\n\n    start () {\n        // Your initialization goes here.\n\n        if (PlayerData.instance.playerInfo.level > 1 && this.ndTip.active) {\n            this.ndTip.active = false;\n        }\n    }\n\n    onEnable () {\n        this.node.on(Node.EventType.TOUCH_START, this._touchStartEvent, this);\n        this.node.on(Node.EventType.TOUCH_MOVE, this._touchMoveEvent, this);\n\n        // 触摸在圆圈内离开或在圆圈外离开后，摇杆归位，player速度为0\n        this.node.on(Node.EventType.TOUCH_END, this._touchEndEvent, this);\n        this.node.on(Node.EventType.TOUCH_CANCEL, this._touchEndEvent, this);\n    }\n\n    onDisable () {\n        this.node.off(Node.EventType.TOUCH_START, this._touchStartEvent, this);\n        this.node.off(Node.EventType.TOUCH_MOVE, this._touchMoveEvent, this);\n\n        // 触摸在圆圈内离开或在圆圈外离开后，摇杆归位，player速度为0\n        this.node.off(Node.EventType.TOUCH_END, this._touchEndEvent, this);\n        this.node.off(Node.EventType.TOUCH_CANCEL, this._touchEndEvent, this);\n\n        //重置\n        this.isMoving = false;\n        this.ndDot.setPosition(this._oriDotPos);\n        if (this._oriRingPos) {\n            this.ndRing.setPosition(this._oriRingPos);\n        }\n    }\n\n    private _touchStartEvent (event: EventTouch) {\n        // 记录触摸的世界坐标，给touch move使用\n        // this.dot.opacity = 255;\n        this._targetRingPos = null!;\n\n        let touch = event.getUILocation();\n        this._touchStartLocation.set(touch.x, touch.y, 0);\n        let touchPos = this.node.getComponent(UITransformComponent)?.convertToNodeSpaceAR(this._touchStartLocation) as Vec3;\n\n        if (!this._oriRingPos) {\n            this._oriRingPos = this.ndRing.getPosition().clone();\n        }\n\n        // 记录摇杆位置，给touch move使用\n        // this._stickPos.set(touchPos);\n\n        this._isOutInnerSize = false;\n\n        if (!this.isFollowStart) {\n            touchPos = this.ndRing.getComponent(UITransformComponent)?.convertToNodeSpaceAR(this._touchStartLocation) as Vec3;\n\n            //触摸点与圆圈中心的距离\n            let distance = touchPos.length();\n            let width = this.ndRing.getComponent(UITransformComponent)?.contentSize.width as number;\n            //圆圈半径\n            let radius = width / 2;\n            \n            //手指在圆圈内触摸,控杆跟随触摸点\n            if (radius > distance) {\n                this.ndDot.setPosition(touchPos);\n                this._updateAngle(touchPos);\n                return true;\n            }\n            return false;\n\n        } else  {\n            //设置遥感可移动范围\n            if (this.touchType === TOUCH_TYPE.FOLLOW) {\n                touchPos.y = touchPos.y >= -screenHeight/6 ? -screenHeight/6 : touchPos.y;\n            } \n\n            this.ndRing.setPosition(touchPos);\n        }\n    }\n\n    private _touchMoveEvent (event: EventTouch) {\n        let touch = event.getUILocation();\n        this._touchMoveLocation.set(touch.x, touch.y, 0);\n        let touchPos = this.ndRing.getComponent(UITransformComponent)?.convertToNodeSpaceAR(this._touchMoveLocation) as Vec3;\n\n        // if (this.touchType === TOUCH_TYPE.FOLLOW) {\n        //     let offsetPos = cc.v3(touchPos.x - this._stickPos.x, touchPos.y - this._stickPos.y, 0);\n        //     touchPos = offsetPos;\n        // }\n\n        let distance = touchPos.length();\n\n        if (distance > this.innerSize) {\n            this.isMoving = true;\n            this._isOutInnerSize = true;\n        } else {\n            this._isOutInnerSize = false;\n        }\n\n        //有拖动且有角度才视为开始游戏\n        if (!GameManager.isGameStart && this.isMoving) {\n            GameManager.isGameStart = true;\n            AudioManager.instance.resumeAll();\n            \n            ClientEvent.dispatchEvent(Constant.EVENT_TYPE.MONSTER_MOVE);\n\n            if (this.ndTip.active) {\n                this.ndTip.active = false;\n            }\n\n            this._currentTime = this._checkInterval;\n        }\n\n        let width = this.ndRing.getComponent(UITransformComponent)?.contentSize.width as number;\n        //圆圈半径\n        let radius = width / 2;\n        let rate = 0;\n        // 由于摇杆的postion是以父节点为锚点，所以定位要加上ring和dot当前的位置(stickX,stickY)\n        if (radius > distance) {\n            rate = Number((distance / radius).toFixed(3));\n            this.ndDot.setPosition(touchPos);\n        }\n        else if (this.touchType !== TOUCH_TYPE.FOLLOW_DOT) {\n            rate = 1;\n            //控杆永远保持在圈内，并在圈内跟随触摸更新角度\n            let radian = Math.atan2(touchPos.y, touchPos.x);\n            \n            let x = Math.cos(radian) * radius;\n            let y = Math.sin(radian) * radius;\n            this._movePos.set(x, y, 0);\n            if (this.touchType === TOUCH_TYPE.FOLLOW_ALWAYS) {\n                this._curRingPos_2.set(touch.x - x, touch.y - y, 0);\n                let ringPos = this.node.getComponent(UITransformComponent)?.convertToNodeSpaceAR(this._curRingPos_2) as Vec3;\n                this._targetRingPos = ringPos;\n            }\n\n            this.ndDot.setPosition(this._movePos);\n        } else { \n            // 点跟随移动\n            this.ndDot.setPosition(touchPos);\n        }\n        //更新角度\n        this._updateAngle(touchPos);\n        //更新遥感移动距离百分比\n        this._distanceRate = rate;\n    }\n\n    private _touchEndEvent (event: EventTouch) {\n        if (!this.isMoving) {\n            //可以判断为点击\n            this.onClickCb && this.onClickCb();\n        } else {\n            let touch = event.getUILocation();\n            this._touchEndLocation.set(touch.x, touch.y, 0);\n            let touchPos = this.ndRing.getComponent(UITransformComponent)?.convertToNodeSpaceAR(this._touchEndLocation) as Vec3;\n            let isDragToInner = false;\n            if (touchPos.length() < this.innerSize) {\n                //取消掉\n                isDragToInner = true;\n                \n                this.onEndCb && this.onEndCb(isDragToInner);\n                \n            } else {\n                this.onEndCb && this.onEndCb(isDragToInner);\n            }\n        }\n\n        this.isMoving = false;\n        this.ndDot.setPosition(this._oriDotPos);\n\n        if (this.touchType === TOUCH_TYPE.FOLLOW || this.touchType === TOUCH_TYPE.FOLLOW_ALWAYS || this.touchType === TOUCH_TYPE.FOLLOW_DOT) {\n            this._targetRingPos = null!;\n            this.ndRing.setPosition(this._oriRingPos);\n        }\n    }\n\n    private _updateAngle (pos: Vec3) {\n        this._angle = Math.round(Math.atan2(pos.y, pos.x) * 180 / Math.PI);\n        return this._angle;\n    }\n\n    public reset () {\n        this.isMoving = false;\n        this.ndDot.setPosition(this._oriDotPos);\n    }\n\n    update (deltaTime: number) {\n        // Your update function goes here.\n\n        if (!GameManager.isGameStart || GameManager.isGameOver || GameManager.isGamePause || !GameManager.scriptPlayer) {\n            return;\n        }\n\n        //设置终终点按钮位置\n        if (this._targetRingPos) {\n            this._curRingPos_1.set(0, 0, 0);\n            Vec3.lerp(this._curRingPos_1, this.ndRing.position, this._targetRingPos, 20 * deltaTime);\n\n            this.ndRing.setPosition(this._curRingPos_1);\n        }\n\n        this._currentTime += deltaTime;\n        \n        if (this._currentTime >= this._checkInterval) {\n            this._currentTime = 0;\n\n            if (this.isMoving) {\n                if (this.angle !== this._oldAngle) {\n                    this._oldAngle = this.angle;\n                    GameManager.scriptPlayer.playAction({action: Constant.PLAYER_ACTION.MOVE, value: this.angle});\n                }\n            } else {\n                this.isMoving = false;\n                if (GameManager.scriptPlayer.isMoving) {\n                    GameManager.scriptPlayer.playAction({action: Constant.PLAYER_ACTION.STOP_MOVE});\n                }\n            }\n        }\n    }\n}\n"]}